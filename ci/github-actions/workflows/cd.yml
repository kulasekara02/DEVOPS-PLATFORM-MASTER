# =============================================================================
# CD Pipeline - Continuous Deployment
# =============================================================================
# Deploys to kind cluster on push to main
# Runs smoke tests and rolls back on failure
# =============================================================================

name: CD Pipeline

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}
  KIND_CLUSTER_NAME: devops-platform
  NAMESPACE: devops-platform

jobs:
  # ===========================================================================
  # Deploy to Kind Cluster
  # ===========================================================================
  deploy:
    name: Deploy to Kind
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Create kind cluster
        run: |
          cat <<EOF | kind create cluster --name ${{ env.KIND_CLUSTER_NAME }} --config=-
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            kubeadmConfigPatches:
            - |
              kind: InitConfiguration
              nodeRegistration:
                kubeletExtraArgs:
                  node-labels: "ingress-ready=true"
            extraPortMappings:
            - containerPort: 80
              hostPort: 80
              protocol: TCP
            - containerPort: 443
              hostPort: 443
              protocol: TCP
          - role: worker
          EOF

      - name: Install ingress-nginx
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=120s

      - name: Build and load images to kind
        run: |
          # Build images
          docker build -t ${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }} \
            -f infra/docker/Dockerfile.frontend --target production .
          docker build -t ${{ env.IMAGE_PREFIX }}/api:${{ github.sha }} \
            -f infra/docker/Dockerfile.api --target production .
          docker build -t ${{ env.IMAGE_PREFIX }}/worker:${{ github.sha }} \
            -f infra/docker/Dockerfile.worker --target production .

          # Load images into kind
          kind load docker-image ${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }} --name ${{ env.KIND_CLUSTER_NAME }}
          kind load docker-image ${{ env.IMAGE_PREFIX }}/api:${{ github.sha }} --name ${{ env.KIND_CLUSTER_NAME }}
          kind load docker-image ${{ env.IMAGE_PREFIX }}/worker:${{ github.sha }} --name ${{ env.KIND_CLUSTER_NAME }}

      - name: Create namespace and secrets
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

          kubectl create secret generic app-secrets \
            --from-literal=POSTGRES_USER=devops \
            --from-literal=POSTGRES_PASSWORD=devops_ci_password \
            --from-literal=DATABASE_URL=postgresql://devops:devops_ci_password@postgres:5432/devops_platform \
            --from-literal=REDIS_URL=redis://redis:6379/0 \
            --from-literal=JWT_SECRET=ci-jwt-secret-for-testing \
            --namespace ${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy with Kustomize
        run: |
          # Update image tags
          cd infra/k8s/overlays/dev

          kustomize edit set image \
            ghcr.io/devops-platform-master/frontend=${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }} \
            ghcr.io/devops-platform-master/api=${{ env.IMAGE_PREFIX }}/api:${{ github.sha }} \
            ghcr.io/devops-platform-master/worker=${{ env.IMAGE_PREFIX }}/worker:${{ github.sha }}

          # Apply manifests
          kustomize build . | kubectl apply -f -

      - name: Wait for deployment
        run: |
          kubectl rollout status deployment/dev-api -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl rollout status deployment/dev-frontend -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl rollout status deployment/dev-worker -n ${{ env.NAMESPACE }} --timeout=300s

      - name: Get deployment status
        run: |
          kubectl get pods -n ${{ env.NAMESPACE }}
          kubectl get services -n ${{ env.NAMESPACE }}
          kubectl get ingress -n ${{ env.NAMESPACE }}

  # ===========================================================================
  # Smoke Tests
  # ===========================================================================
  smoke-test:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run smoke tests
        run: |
          chmod +x ci/scripts/smoke_test.sh
          ./ci/scripts/smoke_test.sh http://localhost:8080

  # ===========================================================================
  # Rollback on Failure
  # ===========================================================================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: [deploy, smoke-test]
    if: failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Rollback deployment
        run: |
          echo "Smoke tests failed. Rolling back..."
          kubectl rollout undo deployment/dev-api -n ${{ env.NAMESPACE }}
          kubectl rollout undo deployment/dev-frontend -n ${{ env.NAMESPACE }}
          kubectl rollout undo deployment/dev-worker -n ${{ env.NAMESPACE }}

      - name: Wait for rollback
        run: |
          kubectl rollout status deployment/dev-api -n ${{ env.NAMESPACE }}
          kubectl rollout status deployment/dev-frontend -n ${{ env.NAMESPACE }}
          kubectl rollout status deployment/dev-worker -n ${{ env.NAMESPACE }}

      - name: Notify failure
        run: |
          echo "::error::Deployment failed and was rolled back"
